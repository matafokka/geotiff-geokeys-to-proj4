<html>
<head>
</head>
<body style="background: transparent;">
    <script src="scripts/docstrap.lib.js"></script>
    <script src="scripts/lunr.min.js"></script>
    <script src="scripts/fulltext-search.js"></script>

    <script type="text/x-docstrap-searchdb">
    {"modules.list.html":{"id":"modules.list.html","title":"Modules","body":" geotiff-geokeys-to-proj4 Modules geokeysToProj4 Modules Ã— Search results Close (c) matafokka Documentation generated by JSDoc 3.6.6 on 2024-04-12T17:28:58+00:00 using the DocStrap template. "},"index.html":{"id":"index.html","title":"Index","body":" geotiff-geokeys-to-proj4 Modules geokeysToProj4 geotiff-geokeys-to-proj4 This library converts GeoTIFF's geokeys to Proj4 string, so you can consume your images. Intended to be used with geotiff.js and proj4js, it's basically a glue between these libraries, but it can be used with alternatives. Designed for both frontend and backend. Supports ES3+ environments (any browser from 2000 year). Size is ~1.46 Mb (despite what npm says, it counts both sources and bundle). Grab it from npm: npm install geotiff-geokeys-to-proj4. Looking for maintainers! EPSG updates their database once in a month, these updates needs to be integrated into this library. For now, there's no one to perform this task. If you want to help, please, see how to update the database, create an issue to let me know that we've got a maintainer, and submit pull requests with the updated files. Docs Demo &amp; example GeoTIFF 3D DEM Viewer demonstrates how to read GeoTIFF files and display them in CesiumJS as 3D terrain. Check the source code for more. Files that'll interest you the most: initial image setup, where all interesting stuff is. Still, be sure to check out usage example below! Usage Importing this library In Node.js or with bundler: const geokeysToProj4 = require(\"geotiff-geokeys-to-proj4\"); In TypeScript: import geokeysToProj4 from \"geotiff-geokeys-to-proj4\"; or import { toProj4, convertCoordinates } from \"geotiff-geokeys-to-proj4\"; In a browser: &lt;script src=\"path/to/main-dist-iife.js\"&gt;&lt;/script&gt; - after that you'll have geokeysToProj4 global variable. Please note that ESM module is not transpiled to ES3. Use a bundler to transpile your app to whatever ES version you need. General usage In general, you want to: Read geokeys. Pass them to geokeysToProj4.toProj4() (let's call returned object projObj). Pass projObj.proj4 (which is Proj4 string) to proj4js. Convert pixel coordinates and pixel value (Z coordinate; DEM or geocentric CRS only; for other files, use any number, it doesn't matter) to CRS coordinates (let's call them crsX, crsY and crsZ). Convert CRS coordinates to usable units (in most cases, meters or degrees, but GeoTIFF allows speed, angular speed, and scale): geokeysToProj4(crsX, crsY, crsZ, projObj.coordinatesConversionParameters). The returned object will contain x, y, z coordinates which are ready to be projected with proj4js. So project them. Of course, you can alter this workflow to use this library with any other (presumably, server-side) software. Let's demonstrate everything from start to finish on an example with geotiff.js and proj4js: // Import all the stuff const geotiff = require(\"geotiff\"); // geotiff.js const proj4 = require(\"proj4\"); // proj4js const geokeysToProj4 = require(\"geotiff-geokeys-to-proj4\"); // This library // Let's wrap our example in a function async function workWithGeoTIFF(blob) { // Read image. See geotiff.js docs on what all of that means. const tiff = await geotiff.fromBlob(blob); // Read blob const imageCount = await tiff.getImageCount(); // Get image count // Work with each image in a file for (let i = 0; i &lt; imageCount; i++) { const image = await tiff.getImage(i); // Get image instance const geoKeys = image.getGeoKeys(); // Get geokeys const projObj = geokeysToProj4.toProj4(geoKeys); // Convert geokeys to proj4 string // The function above returns an object where proj4 property is a Proj4 string and coordinatesConversionParameters is conversion parameters which we'll use later const projection = proj4(projObj.proj4, \"WGS84\"); // Project our GeoTIFF to WGS84 // Now you may want to deal with errors. Unfortunately, errors are unavoidable, but in most cases, you can warn the user or just continue on. // All occurred errors will be in projObj.errors object. See the docs for more information: // https://matafokka.github.io/geotiff-geokeys-to-proj4/module-geokeysToProj4.html#.ConversionErrors__anchor // Work with pixels // For looping over pixels const width = image.getWidth(); const height = image.getHeight(); // Pixel dimensions for converting image coordinates to source CRS coordinates const [originX, originY] = image.getOrigin(); const [xSize, ySize] = image.getResolution(); // Read rows for (let y = 0; y &lt; height; y++) { // Read one row of pixels. Easier to deal with coordinates, takes less RAM. const raster = await image.readRasters({window: [0, y, width, y + 1]}); const color0 = raster[0]; // Raster is a TypedArray where elements are colors and their elements are pixel values of that color // Read columns. Since we're reading full row, we can replace color0.length with width, but I find color0.length more explicit. for (let x = 0; i &lt; color0.length; x++) { // Convert current pixel's coordinates to CRS by: // 1. Multiplying current coordinates by pixel size which will result in distance from top-left corner in CRS units. // 2. Adding this value to top-left corner coordinates which will result in \"global\" coordinates in CRS units. // This will work because image is transformed by Affine Transformation which preserves parallelism. // Warning: this logic works only for source CRS, target CRS might screw up parallel lines, so pixel dimensions will not be constant! const crsX = originX + x * xSize; const crsY = originY + y * ySize; // DEM or geocentric CRS only: Z coordinate is pixel value. You may want to use another band or a combination of bands as Z coordinate. // For other files, you may use any number instead, it doesn't matter. const crsZ = color0[i]; // Check if coordinates are already in meters (or other \"standard\" units). If not, convert them. Either: // 1. Use convertCoordinates(): let point; if (projObj.shouldConvertCoordinates) // You can remove this condition, convertCoordinates() will work just fine in any case. Just a bit of time saving when dealing with large files. point = geokeysToProj4.convertCoordinates(crsX, crsY, crsZ, projObj.coordinatesConversionParameters); else point = { x: crsX, y: crsY, z: crsZ }; // 2. Just multiply manually to speed up execution by removing function calls and conditions: point = { x: crsX * projObj.coordinatesConversionParameters.x, y: crsY * projObj.coordinatesConversionParameters.y, z: crsZ * projObj.coordinatesConversionParameters.z, } let projectedPoint = projection.forward(point); // Project these coordinates // Work with projected coordinates... } } } } Known issues I don't know which geokeys should take precedence over which. I did what seems to be logical, but I might be wrong. If you know anything about it, please, create an issue and describe whether I'm wrong (and how to fix it) or right (so I'll remove this text). Vertical CRS which use local depth are not supported because reference points are needed. Following has been excluded: Vertical CS: 1049 and 1050. Vertical CRS: 8378 and 8897. Vertical datums are not supported at all because mappings are needed. If you have at least some mappings, please, let me know by creating an issue. Manually updating from EPSG database Unfortunately, epsg.org doesn't provide public access to their database. You need to register an account, and only then you'll be able to download database. Since all of that is for the users and not for bots, both client and server might change in the future, so there's no point in writing self-update script. To update: Clone this repo. Run npm install on cloned repo. Set up PostgreSQL server (other RDBMS are not supported). Default configuration should be fine, just create a user and a database for that user. Head over to here, create an account (if you don't have one) and download PostgreSQL scripts. Extract downloaded scripts to postgres_prep directory. Run npm run update-all to update everything and rebuilds the project. See arguments below. Warning: this script utilizes epsg schema and will erase it completely! It's hardcoded and can't be changed. To avoid data loss, create a separate database solely to run this script. There're actually two scripts: update-all which has been described above and update-existing which will update project files from existing database. Both of these scripts accepts following arguments: --host - PostgreSQL host - Defaults to \"localhost\" --port - PostgreSQL port - Defaults to \"5432\" --database - Database containing \"epsg\" schema - Defaults to \"postgres\" --user - PostgreSQL database user - Defaults to \"user\" --password - Password for the user - Defaults to \"12345\" Arguments passed to npm scripts in following manner: npm run [script name] -- [script arguments], for example: npm run update-all -- --user myuser --password mypassword. Note the -- separator, it should always present when using this library's scripts. FAQ Why do I need it? Every GeoTIFF is bound to some kind of Coordinate Reference System (CRS) which in combination with georeferencing data defines where pixel coordinates are on the Earth. These CRS are quite different from what you can find, let's say, in Leaflet or OpenLayers which uses WGS (which is CRS too) by default. So you need to convert image coordinates from one CRS to another. proj4js is the best tool to do that. You need to supply an input and output CRS (which Proj4 calls a projection; yes, terminology is quite confusing) to it in form of a string. For output, you can specify whatever your software is using. But input is defined by geokeys (information embedded into GeoTIFF file). Geokeys are really hard to handle. This library will create an input Proj4 string for you. How to perform all of that is described in example above. Without these procedures, you'll get wrong results. How is it different from epsg-index? epsg-index only provides projections definitions, GeoTIFF uses more than that. How does it compare to already existing and battle-proven libraries such as GDAL? Pros: Can be used in a browser. There're no alternatives for now except for compiling another library to WebAssembly. Even then this library wins because it can run in ES3 environment (any browser from 2000 year). Easier to use in Node since this library is written in pure JS. Non-JS libraries requires a wrapper or use of CLI. Cons: Libraries such as GDAL are, in fact, already battle-proven. Since this library is new, I'm the sole developer for now, and I'm not a cartographer, there might be some bugs. Since there're no maintainers to update database, more popular libraries might have newer data, though, it shouldn't make big difference. To summarize: use this library for a frontend, but existing libraries with a wrapper might be better for a backend; The example above can be put in a function that takes a callback. Why didn't you do that? Because: It's not the goal of this library. It'll slow down reading which is already quite slow. You'll still need to understand how all this stuff works and be able to modify the example when needed. This library produces wrong results! This library only maps geokeys to their Proj4 definitions and builds a final Proj4 string. It doesn't perform any projections. If you've encountered a bug, please, take a look at Proj4 string first and compare it to one generated by a professional GIS. If something is fundamentally wrong, it's the issue of this library. Otherwise, there's something wrong with Proj4. If you're comparing results with what epsg.io says, note that while epsg.io is mostly right, it's not an official data source. For example, epsg.io maps CRS 21780 to +proj=somerc, but the right projection seems to be +proj=omerc. If you're not sure how to verify which Proj4 string is correct, feel free to message me anyway. Please, don't report redundant parameters (for example, +a and +b that are the same as +ellps provides) as a bug. This behavior simplifies development, increases performance by not making useless comparisons and ensures that the right parameters are used. Missing +units is also not a bug, you're converting coordinates to meters by using geokeysToProj4.convertCoordinates(). What are the sources for Proj4 strings? Official database from epsg.org is the main data source. Data is enriched by some additional sources. epsg.io is used to selectively check if Proj4 strings are correct. Contributing You can contribute by solving described issues or by maintaining the database. Related projects geotiff.js is a library that can read GeoTIFF images. proj4js is a port of Proj4 to JS. epsg-index is a machine-readable index of all EPSG coordinate reference systems. epsg.io is a website that provides all the EPSG stuff mostly in human-readable form, and an API to access it. geokeys-to-proj4js is a project with the same goal but far from to be finished, and it looks abandoned. Ã— Search results Close (c) matafokka Documentation generated by JSDoc 3.6.6 on 2024-04-12T17:28:58+00:00 using the DocStrap template. "},"module-geokeysToProj4.html":{"id":"module-geokeysToProj4.html","title":"Module: geokeysToProj4","body":" geotiff-geokeys-to-proj4 Modules geokeysToProj4 Module: geokeysToProj4 This library converts geokeys to Proj4 string and contains following functions: module:geokeysToProj4.toProj4 Does actual conversion module:geokeysToProj4.convertCoordinates Converts coordinates to use with proj4 In general, you want to: Read geokeys. Pass them to geokeysToProj4.toProj4() (let's call returned object projObj). Pass projObj.proj4 (Proj4 string) to proj4js. Convert pixel coordinates to CRS coordinates (let's call them crsX and crsY). Convert CRS coordinates to usable units (in most cases, meters, but GeoTIFF allows speed, angular speed, and scale): geokeysToProj4(crsX, crsY, projObj.coordinatesConversionParameters). The returned object contains X, Y, Z coordinates. which are ready to be projected with proj4js. So project them. Of course, you can alter this workflow to use this library with any other (presumably, server-side) software. Methods &lt;static&gt; convertCoordinates(x, y, z, parameters) Converts given coordinates to standard ones (i.e. meters or degrees). Basically, a short way to multiply x, y, z by parameters.x, parameters.y and parameters.z respectively. It does NOT accept image coordinates! Convert image coordinates to projection coordinates first (by multiplying image coordinates by image.getResolution() and adding coordinates of a top left corner) and then pass converted coordinates to this function. Parameters: Name Type Description x number X coordinate y number Y coordinate z number Pixel value, i.e. Z coordinate. If you don't use DEM, pass any number. parameters Object getProjectionParameters().coordinatesConversionParameters Returns: Converted coordinates Type module:geokeysToProj4.Point &lt;static&gt; toProj4(geoKeys) Converts GeoTIFFs geokeys to Proj4 string Parameters: Name Type Description geoKeys GeoKeys Object where keys are geokeys (named exactly as in GeoTIFF specification) and values are, well, their values. Returns: Projection parameters Type module:geokeysToProj4.ProjectionParameters Type Definitions ConversionErrors Errors that have occurred during conversion. Apart from listed properties, there's properties that named after geokeys with NotSupported suffix, i.e. ProjFalseOriginLongGeoKeyNotSupported. Values are EPSG codes assigned to those keys. These errors mean that the specified EPSG code is either not supported by this library, or it's new and hasn't been added yet. If it's the latter, please, create an issue at https://github.com/matafokka/geotiff-geokeys-to-proj4 If an error has not occurred, it won't be present in this object. How to process these errors: If it's your program's user's GeoTIFF, show an error message. If it's your GeoTIFF, fix it in a GIS. If you're sure that file is fine or want to discuss it, please, create an issue at https://github.com/matafokka/geotiff-geokeys-to-proj4 Type: Object Properties: Name Type Description bothGCSAndPCSAreSet boolean true When both GeodeticCRSGeoKey (or GeographicTypeGeoKey) and ProjectedCRSGeoKey (or ProjectedCSTypeGeoKey) geokeys are set. In this case, GeographicTypeGeoKey is used. The cause of this error is broken geokeys. CRSNotSupported number Specified CRS can't be represented as Proj4 string or it's new and hasn't been added to this library. Value is EPSG code of specified CRS. GeogLinearUnitSizeGeoKeyNotDefined number Geokey GeogLinearUnitsGeoKey is set to user-defined, but user hasn't specified GeogLinearUnitSizeGeoKey. In this case, every other key using this one assumed to be using meters. The cause of this error is broken geokeys. GeogAngularUnitSizeGeoKeyNotDefined number Geokey GeogAngularUnitsGeoKey is set to user-defined, but user hasn't specified GeogAngularUnitSizeGeoKey. In this case, every other key using this one assumed to be using degrees. The cause of this error is broken geokeys. ProjLinearUnitSizeGeoKeyNotDefined number Geokey ProjLinearUnitsGeoKey is set to user-defined, but user hasn't specified ProjLinearUnitSizeGeoKey. In this case, every other key using this one assumed to be using meters. The cause of this error is broken geokeys. conversionNotSupported number Conversion specified in ProjectionGeoKey is not supported by this library. Value is EPSG conversion code. coordinateTransformationNotSupported number Transformation specified in ProjMethodGeoKey (or ProjCoordTransGeoKey) is not supported by this library. Value is projection code. See http://geotiff.maptools.org/spec/geotiff6.html#6.3.3.3 for more information. verticalCsNotSupported number Vertical CS specified in VerticalGeoKey (or VerticalCSTypeGeoKey) is not supported by this library. Value is EPSG CS code. verticalCsUnitsNotSupported number Vertical CS specified in VerticalUnitsGeoKey is not supported by this library. Value is EPSG uom code. verticalDatumsNotSupported number Vertical datums are not supported by this library. If vertical CRS is user-defined, and VerticalDatumGeoKey is set, this error will be reported. Value is EPSG datum code. CoordinateConversionParameters Parameters to pass to module:geokeysToProj4.convertCoordinates or to convert coordinates manually Type: Object Properties: Name Type Description x number Multiply X coordinate by this parameter to convert it to standard units (meters or degrees) y number Multiply Y coordinate by this parameter to convert it to standard units (meters or degrees) z number Multiply Z coordinate (pixel value) by this parameter to convert it to standard units (meters) GeoKeys Geokeys. If you're working with geotiff library, this is result of image.getGeoKeys(). Type: Object Properties: Name Type Description GeodeticCRSGeoKey number See GeoTIFF docs for more information GeographicTypeGeoKey number See GeoTIFF docs for more information GeodeticDatumGeoKey number See GeoTIFF docs for more information GeogGeodeticDatumGeoKey number See GeoTIFF docs for more information PrimeMeridianGeoKey number See GeoTIFF docs for more information GeogPrimeMeridianGeoKey number See GeoTIFF docs for more information GeogLinearUnitsGeoKey number See GeoTIFF docs for more information GeogLinearUnitSizeGeoKey number See GeoTIFF docs for more information GeogAngularUnitsGeoKey number See GeoTIFF docs for more information GeogAngularUnitSizeGeoKey number See GeoTIFF docs for more information GeogEllipsoidGeoKey number See GeoTIFF docs for more information EllipsoidSemiMajorAxisGeoKey number See GeoTIFF docs for more information GeogSemiMajorAxisGeoKey number See GeoTIFF docs for more information EllipsoidSemiMinorAxisGeoKey number See GeoTIFF docs for more information GeogSemiMinorAxisGeoKey number See GeoTIFF docs for more information EllipsoidInvFlatteningGeoKey number See GeoTIFF docs for more information GeogInvFlatteningGeoKey number See GeoTIFF docs for more information PrimeMeridianLongitudeGeoKey number See GeoTIFF docs for more information PrimeMeridianLongitudeGeoKey number See GeoTIFF docs for more information GeogPrimeMeridianLongGeoKey number See GeoTIFF docs for more information ProjectedCRSGeoKey number See GeoTIFF docs for more information ProjectedCSTypeGeoKey number See GeoTIFF docs for more information ProjectionGeoKey number See GeoTIFF docs for more information ProjMethodGeoKey number See GeoTIFF docs for more information ProjCoordTransGeoKey number See GeoTIFF docs for more information ProjLinearUnitsGeoKey number See GeoTIFF docs for more information ProjLinearUnitSizeGeoKey number See GeoTIFF docs for more information ProjStdParallel1GeoKey number See GeoTIFF docs for more information ProjStdParallel2GeoKey number See GeoTIFF docs for more information ProjNatOriginLongGeoKey number See GeoTIFF docs for more information ProjNatOriginLatGeoKey number See GeoTIFF docs for more information ProjFalseEastingGeoKey number See GeoTIFF docs for more information ProjFalseNorthingGeoKey number See GeoTIFF docs for more information ProjFalseOriginLongGeoKey number See GeoTIFF docs for more information ProjFalseOriginLatGeoKey number See GeoTIFF docs for more information ProjFalseOriginEastingGeoKey number See GeoTIFF docs for more information ProjFalseOriginNorthingGeoKey number See GeoTIFF docs for more information ProjCenterLongGeoKey number See GeoTIFF docs for more information ProjCenterLatGeoKey number See GeoTIFF docs for more information ProjCenterEastingGeoKey number See GeoTIFF docs for more information ProjCenterNorthingGeoKey number See GeoTIFF docs for more information ProjScaleAtNatOriginGeoKey number See GeoTIFF docs for more information ProjScaleAtCenterGeoKey number See GeoTIFF docs for more information ProjAzimuthAngleGeoKey number See GeoTIFF docs for more information ProjStraightVertPoleLongGeoKey number See GeoTIFF docs for more information VerticalGeoKey number See GeoTIFF docs for more information VerticalCSTypeGeoKey number See GeoTIFF docs for more information VerticalUnitsGeoKey number See GeoTIFF docs for more information GeogTOWGS84GeoKey Array.&lt;number&gt; Datum to WGS transformation parameters, unofficial key Point Represents a point. X and Y coordinates are not necessarily cartesian coordinates (might be lon/lat, depends on CRS) and not in this order (if axes has been swapped by GeoTIFF). Type: Object Properties: Name Type Description x number X coordinate (coordinate of a first axis of CRS) of a point y number Y coordinate (coordinate of a second axis of CRS) of a point z number Z coordinate (coordinate of a third axis of CRS) of a point, i.e. transformed pixel value. Always points up. ProjectionParameters Returned projection parameters Type: Object Properties: Name Type Description proj4 string Proj4 string shouldConvertCoordinates boolean If true, coordinates should be converted by using module:geokeysToProj4.convertCoordinates before passing to proj4js coordinatesConversionParameters CoordinateConversionParameters Parameters to pass to module:geokeysToProj4.convertCoordinates coordinatesUnits \"metre\" | \"metre per second\" | \"second\" | \"radian\" | \"radian per second\" | \"scale\" | \"scale per second\" | \"degree\" Coordinates units after conversion. EPSG defines speed, angular speed and scale as linear units, and GeoTIFF relies on EPSG. So there's a chance that coordinates will represent something's different from distance (in case of PCS). Note: GCS will always use degrees; if PCS uses angles, radians will be used. isGCS boolean If true, geographic (either 2D or 3D) CRS is used. errors module:geokeysToProj4.ConversionErrors Errors that have occurred while processing geokeys. If no error has occurred, there will be an empty object. Ã— Search results Close (c) matafokka Documentation generated by JSDoc 3.6.6 on 2024-04-12T17:28:58+00:00 using the DocStrap template. "}}
    </script>

    <script type="text/javascript">
        $(document).ready(function() {
            Searcher.init();
        });

        $(window).on("message", function(msg) {
            var msgData = msg.originalEvent.data;

            if (msgData.msgid != "docstrap.quicksearch.start") {
                return;
            }

            var results = Searcher.search(msgData.searchTerms);

            window.parent.postMessage({"results": results, "msgid": "docstrap.quicksearch.done"}, "*");
        });
    </script>
</body>
</html>
